<!DOCTYPE html>
<html lang="ja">
<head>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="firebase-init.js"></script>
  <script src="comment.js"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Part3: è‹¦æ‰‹ãªå ´é¢ã®æ•´ç†</title>

  <style>
    /* ===== è¯„è®ºæ•´ä½“å®¹å™¨ï¼ˆä¸å— body flex å½±å“ï¼‰ ===== */
    #commentWrapper {
      width: 100%;
      max-width: 700px;
      margin: 60px auto 80px;
      padding: 0 16px;
      box-sizing: border-box;
      align-self: stretch;
      text-align: left;
    }
    #commentInputArea { margin-bottom: 20px; }
    #commentInputArea h3 { margin-bottom: 10px; color: #FA7DAD; }
    #commentInput {
      width: 100%;
      height: 80px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #E5C8C5;
      resize: none;
      outline: none;
      font-family: inherit;
    }
    #sendCommentBtn {
      margin-top: 10px;
      padding: 8px 18px;
      border-radius: 20px;
      border: none;
      background: #FA7DAD;
      color: white;
      cursor: pointer;
    }
    #commentList {
      background: rgba(255,255,255,0.85);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .commentItem { padding: 10px 0; border-bottom: 1px dashed #F2C6D6; }
    .commentItem:last-child { border-bottom: none; }
    .commentUser { font-weight: bold; color: #FA7DAD; margin-bottom: 4px; }
    .commentText { color: #5C4545; line-height: 1.5; }

    /* ---------- åŸºæœ¬æ ·å¼ï¼ˆä¿ç•™ä½ åŸæ¥çš„é£æ ¼ï¼‰ ---------- */
    body {
      font-family: "Arial", sans-serif;
      background-color: #FBF1F0;
      color: #5C4545;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    h2 {
      text-align: center;
      color: #FA7DAD;
      margin: 20px;
    }

    .intro-text {
      text-align: center;
      max-width: 720px;
      margin: 0 auto 10px;
      line-height: 1.8;
      color: #7a5c5c;
      font-size: 1.05em;
      opacity: 0;
      animation: fadeIn 1.8s ease forwards;
      animation-delay: 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      padding: 20px;
      height: 70vh;
    }

    /* å·¦ä¾§åŸæ ‡ç­¾åŒº */
    .notes {
      width: 30%;
      padding: 10px;
      overflow-y: auto;
    }

    .note {
      background: #ffdee4;
      border: 1px solid #f2a9c2;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      cursor: pointer;
      text-align: center;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
      position: relative;
      user-select: none;
      font-size: calc(12px + 0.4vw);
      line-height: 1.4;
    }

    .note:active { cursor: grabbing; }

    .custom-note {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .custom-note input {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #f2a9c2;
      font-size: calc(12px + 0.4vw);
      background: transparent;
      color: #5C4545;
    }

    .custom-note button {
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      background: #ffd9e3;
      color: #6b5948;
      cursor: pointer;
    }

    /* å³ä¾§ï¼šç±»å‹åˆ†ç±»åŒºåŸŸï¼ˆæ›¿æ¢åŸå››è±¡é™ï¼‰ */
    .axis-area {
      width: 65%;
      position: relative;
      border: 2px solid #FA7DAD;
      border-radius: 12px;
      background: #fff;
      overflow: hidden;
      min-height: 340px;
    }

    /* 2x2 ç±»å‹ç½‘æ ¼ï¼ˆåªåšè§†è§‰å¼•å¯¼ï¼Œä¸å¼ºåˆ¶å¸é™„ï¼‰ */
    .type-grid {
      position: absolute;
      inset: 0;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      z-index: 0;
    }

    .type-zone {
      border: 1px dashed rgba(250,125,173,0.35);
      padding: 14px 12px;
      box-sizing: border-box;
      position: relative;
      background: linear-gradient(
        180deg,
        rgba(251,241,240,0.35),
        rgba(255,255,255,0.0)
      );
    }

    /* è§’è½åœ†è§’æ›´æŸ”å’Œ */
    .zone-tl { border-top-left-radius: 10px; }
    .zone-tr { border-top-right-radius: 10px; }
    .zone-bl { border-bottom-left-radius: 10px; }
    .zone-br { border-bottom-right-radius: 10px; }

    .zone-title {
      display: inline-block;
      font-weight: bold;
      color: #FA7DAD;
      background: #FBF1F0;
      padding: 4px 8px;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .zone-desc {
      font-size: 12px;
      color: #7a5c5c;
      line-height: 1.5;
      opacity: 0.95;
    }

    /* åœ¨ axis-area å†…å‡ºç°çš„å®é™…ä¾¿ç­¾ï¼ˆabsoluteï¼‰ */
    .axis-note {
      position: absolute;
      background: #ffdee4;
      border: 1px solid #f2a9c2;
      border-radius: 8px;
      padding: 8px;
      min-width: 110px;
      max-width: 36vw;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.12);
      touch-action: none;
      font-size: calc(12px + 0.5vw);
      line-height: 1.2;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      z-index: 2; /* ç›–è¿‡èƒŒæ™¯ç½‘æ ¼ */
    }

    .finish-btn {
      margin: 20px auto;
      background: #FA7DAD;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 24px;
      cursor: pointer;
      transition: 0.3s;
      display: block;
    }
    .finish-btn:hover { background: #f95d9f; }

    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(251, 241, 240, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.6s ease;
      z-index: 10;
    }
    .overlay.active { opacity: 1; visibility: visible; }

    .overlay-content {
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      max-width: 800px;
      text-align: left;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.15);
      line-height: 1.7;
      color: #5C4545;
    }

    .overlay-content h3 {
      color: #FA7DAD;
      margin-bottom: 15px;
      text-align: center;
    }

    .next-btn {
      margin-top: 20px;
      background: #FA7DAD;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
      display: block;
    }
    .next-btn:hover { background: #f95d9f; }

    @media (max-width: 768px) {
      .container { flex-direction: column; align-items: center; height: auto; }
      .notes, .axis-area { width: 100%; margin-bottom: 15px; }
      .axis-area { height: 56vh; }
      .note { font-size: calc(12px + 1.2vw); padding: 8px; }
      .axis-note { font-size: calc(10px + 1.4vw); max-width: 46vw; }
      .zone-title { font-size: 13px; }
      .zone-desc { font-size: 11px; }
    }
  </style>
</head>

<body>
  <h2>ğŸŒ¸ è‹¦æ‰‹ãªå ´é¢ã‚’æ•´ç†ã—ã¦ã¿ã‚ˆã† ğŸŒ¸</h2>

  <p class="intro-text">
    ã‚ãªãŸã¯ä»Šã¾ã§ã«ã€æ¬¡ã®ã‚ˆã†ãªã€Œè‹¦æ‰‹ã ãªã€ã¨æ„Ÿã˜ãŸå ´é¢ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ<br>
    å·¦ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å³ã®ã‚¨ãƒªã‚¢ä¸­å¤®ã«ãƒ¡ãƒ¢ãŒä½œæˆã•ã‚Œã¾ã™ã€‚<br>
    ä½œæˆå¾Œã¯ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã€ã„ã¡ã°ã‚“è¿‘ã„ã€Œã—ã‚“ã©ã•ã‚¿ã‚¤ãƒ—ã€ã®å ´æ‰€ã¸ç½®ã„ã¦ã¿ã¦ãã ã•ã„ã€‚<br>
    æ­£è§£ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç›´æ„Ÿã§OKã§ã™ğŸŒ·
  </p>

  <div class="container">
    <div class="notes" id="notes">
      <div class="note" data-label="1. å¤§å‹¢ã®å‰ã§ç™ºè¡¨ã™ã‚‹">1. å¤§å‹¢ã®å‰ã§ç™ºè¡¨ã™ã‚‹</div>
      <div class="note" data-label="2. è¦‹ã‚‰ã‚Œã¦ã„ã‚‹çŠ¶æ³ã§ä½œæ¥­ã™ã‚‹">2. è¦‹ã‚‰ã‚Œã¦ã„ã‚‹çŠ¶æ³ã§ä½œæ¥­ã™ã‚‹</div>
      <div class="note" data-label="3. çŸ¥ã‚‰ãªã„äººã¨é•·æ™‚é–“ä¸€ç·’ã«ã„ã‚‹">3. çŸ¥ã‚‰ãªã„äººã¨é•·æ™‚é–“ä¸€ç·’ã«ã„ã‚‹</div>
      <div class="note" data-label="4. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã£ã¦ã“ãªã„">4. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã£ã¦ã“ãªã„</div>
      <div class="note" data-label="5. é¨’éŸ³ã®ä¸­ã§ä¼‘ã‚€">5. é¨’éŸ³ã®ä¸­ã§ä¼‘ã‚€</div>
      <div class="note" data-label="6. åˆºæ¿€çš„ãªæ˜ åƒã‚’è¦‹ã‚‹">6. åˆºæ¿€çš„ãªæ˜ åƒã‚’è¦‹ã‚‹</div>

      <div class="note custom-note" id="customNote">
        <input id="customInput" type="text" placeholder="â• ã‚ãªãŸè‡ªèº«ã®å ´é¢ã‚’è¿½åŠ " />
        <button id="customAddBtn">è¿½åŠ </button>
      </div>
    </div>

    <div class="axis-area" id="axis-area">
      <!-- èƒŒæ™¯åˆ†ç±»ç½‘æ ¼ -->
      <div class="type-grid" aria-hidden="true">
        <div class="type-zone zone-tl">
          <div class="zone-title">ğŸ§  è€ƒãˆã™ãã¦ç–²ã‚Œã‚‹ã‚¿ã‚¤ãƒ—</div>
          <div class="zone-desc">ã¤ã„æ·±ãè€ƒãˆã¦ã—ã¾ã†ï¼æ°—ã«ã—ã™ãã¦ã—ã¾ã†</div>
        </div>
        <div class="type-zone zone-tr">
          <div class="zone-title">ğŸ˜£ åˆºæ¿€ã§æ¶ˆè€—ã™ã‚‹ã‚¿ã‚¤ãƒ—</div>
          <div class="zone-desc">éŸ³ãƒ»å…‰ãƒ»åŒ‚ã„ãƒ»äººã®å¤šã•ãªã©ã«å¼±ã„</div>
        </div>
        <div class="type-zone zone-bl">
          <div class="zone-title">ğŸ˜° äººã¨ã®é–¢ä¿‚ã§æ¶ˆè€—ã™ã‚‹ã‚¿ã‚¤ãƒ—</div>
          <div class="zone-desc">æ°—ã‚’ã¤ã‹ã„ã™ãã‚‹ï¼ç©ºæ°—ã‚’èª­ã¿ã™ãã‚‹</div>
        </div>
        <div class="type-zone zone-br">
          <div class="zone-title">ğŸ˜– ä½“ã«å‡ºã‚„ã™ã„ã‚¿ã‚¤ãƒ—</div>
          <div class="zone-desc">ç·Šå¼µã™ã‚‹ã¨ä½“ãŒã“ã‚ã°ã‚‹ï¼ç–²ã‚Œã‚„ã™ã„</div>
        </div>
      </div>
    </div>
  </div>

  <button class="finish-btn" id="finishBtn">å®Œæˆ âœ¨</button>

  <div class="overlay" id="overlay">
    <div class="overlay-content">
      <h3>ğŸŒ· ã‚ãªãŸã®ã€Œã—ã‚“ã©ã•ã€ã®å‚¾å‘ãŒè¦‹ãˆã¦ãã¾ã—ãŸ ğŸŒ·</h3>

      <p>
        äººã«ã¯ãã‚Œãã‚Œã€<br>
        ãƒ»è€ƒãˆã‚„ã™ã„ãƒã‚¤ãƒ³ãƒˆ<br>
        ãƒ»ç–²ã‚Œã‚„ã™ã„åˆºæ¿€<br>
        ãƒ»æ°—ã‚’ã¤ã‹ã„ã‚„ã™ã„å ´é¢<br>
        ãŒã‚ã‚Šã¾ã™ã€‚
      </p>

      <p>
        ãã‚Œã¯ã€Œå¼±ã•ã€ã§ã¯ãªãã€<strong>æ„Ÿã˜å–ã‚‹åŠ›ãŒé«˜ã„ã‚µã‚¤ãƒ³</strong>ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚<br>
        ã¾ãšã¯ã€Œè‡ªåˆ†ã¯ã“ã†ã„ã†ã‚¿ã‚¤ãƒ—ãªã‚“ã ã€ã¨çŸ¥ã£ã¦ã‚ã’ã‚‹ã“ã¨ã‹ã‚‰ã€ã¯ã˜ã‚ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
      </p>

      <button class="next-btn" onclick="window.location.href='4.html'">ğŸ‘‰ æ¬¡ã¸</button>
    </div>
  </div>

  <script>
    /* ----------------- DOM å…ƒç´  ----------------- */
    const notesList = document.querySelectorAll(".notes .note:not(.custom-note)");
    const axisArea = document.getElementById("axis-area");
    const customAddBtn = document.getElementById("customAddBtn");
    const customInput = document.getElementById("customInput");
    const finishBtn = document.getElementById("finishBtn");
    const overlay = document.getElementById("overlay");

    /* ---------- å·¥å…·ï¼šé™å®šä½ç½®ï¼ˆåœ¨å³ä¾§åŒºåŸŸå†…ï¼‰ ---------- */
    function clampPosition(x, y, el) {
      const areaRect = axisArea.getBoundingClientRect();
      const w = el.offsetWidth;
      const h = el.offsetHeight;

      const minX = 6;
      const minY = 6;
      const maxX = Math.max(areaRect.width - w - 6, minX);
      const maxY = Math.max(areaRect.height - h - 6, minY);

      return {
        x: Math.max(minX, Math.min(x, maxX)),
        y: Math.max(minY, Math.min(y, maxY))
      };
    }

    /* ---------- åœ¨å³ä¾§åˆ›å»ºä¾¿ç­¾ ---------- */
    function createAxisNote(text, clientX = null, clientY = null) {
      const areaRect = axisArea.getBoundingClientRect();
      const note = document.createElement("div");
      note.className = "axis-note";
      note.textContent = text;
      note.setAttribute("draggable", "true");

      // å…ˆæ”¾è¿› axisArea å†è®¡ç®—å°ºå¯¸æ›´å‡†
      axisArea.appendChild(note);

      let left, top;
      if (clientX !== null && clientY !== null) {
        left = clientX - areaRect.left - note.offsetWidth / 2;
        top = clientY - areaRect.top - note.offsetHeight / 2;
      } else {
        left = (areaRect.width - note.offsetWidth) / 2;
        top = (areaRect.height - note.offsetHeight) / 2;
      }

      const clamped = clampPosition(left, top, note);
      note.style.left = clamped.x + "px";
      note.style.top = clamped.y + "px";

      addDragHandlersToAxisNote(note);
      return note;
    }

    /* ---------- å·¦ä¾§å¡ç‰‡ç‚¹å‡»ï¼šåˆ›å»ºä¾¿ç­¾ ---------- */
    notesList.forEach(label => {
      label.addEventListener("click", () => {
        const text = label.dataset.label || label.textContent;
        createAxisNote(text);
      });
    });

    /* ---------- è‡ªå®šä¹‰åœºæ™¯è¿½åŠ  ---------- */
    customAddBtn.addEventListener("click", () => {
      const val = customInput.value.trim();
      if (!val) { alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      createAxisNote(val);
      customInput.value = "";
    });

    /* ---------- PC æ‹–æ‹½ ---------- */
    let currentDrag = null;

    function addDragHandlersToAxisNote(note) {
      note.addEventListener("dragstart", (ev) => {
        currentDrag = note;
        try { ev.dataTransfer.setData("text/plain", ""); } catch (e) {}
        if (ev.dataTransfer && ev.dataTransfer.setDragImage) {
          const crt = note.cloneNode(true);
          crt.style.position = "absolute";
          crt.style.top = "-9999px";
          document.body.appendChild(crt);
          ev.dataTransfer.setDragImage(crt, crt.offsetWidth / 2, crt.offsetHeight / 2);
          setTimeout(() => document.body.removeChild(crt), 0);
        }
      });

      note.addEventListener("touchstart", touchStartForNote, { passive: false });
      note.addEventListener("touchmove", touchMoveForNote, { passive: false });
      note.addEventListener("touchend", touchEndForNote);
    }

    axisArea.addEventListener("dragover", (e) => e.preventDefault());
    axisArea.addEventListener("drop", (e) => {
      e.preventDefault();
      if (!currentDrag) return;

      const areaRect = axisArea.getBoundingClientRect();
      const x = e.clientX - areaRect.left - currentDrag.offsetWidth / 2;
      const y = e.clientY - areaRect.top - currentDrag.offsetHeight / 2;
      const clamped = clampPosition(x, y, currentDrag);

      currentDrag.style.left = clamped.x + "px";
      currentDrag.style.top = clamped.y + "px";
      axisArea.appendChild(currentDrag);
      currentDrag = null;
    });

    /* ---------- TOUCH æ‹–æ‹½ ---------- */
    let touchState = { el: null, startX: 0, startY: 0, origLeft: 0, origTop: 0 };

    function touchStartForNote(e) {
      e.stopPropagation();
      const touch = e.touches[0];
      touchState.el = e.target.closest(".axis-note");
      if (!touchState.el) return;

      const rect = touchState.el.getBoundingClientRect();
      const areaRect = axisArea.getBoundingClientRect();

      touchState.startX = touch.clientX;
      touchState.startY = touch.clientY;
      touchState.origLeft = rect.left - areaRect.left;
      touchState.origTop = rect.top - areaRect.top;

      touchState.el.style.zIndex = 999;
    }

    function touchMoveForNote(e) {
      if (!touchState.el) return;
      const touch = e.touches[0];
      const dx = touch.clientX - touchState.startX;
      const dy = touch.clientY - touchState.startY;

      const newLeft = touchState.origLeft + dx;
      const newTop = touchState.origTop + dy;

      const clamped = clampPosition(newLeft, newTop, touchState.el);
      touchState.el.style.left = clamped.x + "px";
      touchState.el.style.top = clamped.y + "px";

      e.preventDefault();
    }

    function touchEndForNote() {
      if (!touchState.el) return;
      touchState.el.style.zIndex = 2;
      touchState = { el: null, startX: 0, startY: 0, origLeft: 0, origTop: 0 };
    }

    /* ---------- finish æŒ‰é’® ---------- */
    finishBtn.addEventListener("click", () => {
      overlay.classList.add("active");
      const card = overlay.querySelector(".overlay-content");
      card.scrollIntoView({ behavior: "smooth", block: "center" });
    });

    /* Enter æäº¤ custom */
    customInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        customAddBtn.click();
      }
    });
  </script>

  <!-- Firebase / comment ç³»ç»Ÿï¼ˆä¿ç•™ï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="firebase-init.js"></script>
  <script src="comment.js"></script>
</body>
</html>
